/**
 * Created by jose on 01/09/2015.
 */
const path = require("path");
const winston = require("winston");

import constant from "Constant";

const environment = process.env.NODE_ENV || "production";
const env_debug = process.env.DEBUG || "false";
const in_debug_mode = env_debug === "true";
const LOOKUP_MODE = process.env.EHS_LOOKUP_MODE || "single";

if (in_debug_mode) {
    winston.level = "debug";
}

winston.info(`***** APP CONFIGURATION *****`);
winston.info(`ENVIRONMENT => ${environment}`);
winston.info(`DEBUG MODE => "${env_debug}" evaluates ${in_debug_mode}`);
winston.info(`LOG LEVEL => ${winston.level}`);
winston.info(`LOOKUP_MODE => ${LOOKUP_MODE}`);

export default {
    debug: in_debug_mode,
    environment: environment,
    sequelize: getSequelizeConfig(),
    ROOT_PATH: path.join(__dirname, "../../"),
    API: {
        currencyEurRate: "https://api.fixer.io/latest"
    },
    knexConfig: {
        client: getSequelizeConfig().options.dialect,
    },
    emailConfig: getEmailConfig(),
    enableMultipleLookup: LOOKUP_MODE.toLowerCase() === "multiple",
    constant,
};

function getSequelizeConfig(): any {
    const options = {
        dialect: "mysql",
        host: process.env.MYSQL_HOST || "localhost",
        logging: (str: string) => winston.debug(str),
        pool: {
            idle: 8000,
            max: process.env.MYSQL_POOL_MAX || 8,
            min: process.env.MYSQL_POOL_MIN || 1,
        },
        port: process.env.MYSQL_PORT || "3506",
    };

    const result = {
        db: process.env.MYSQL_DATABASE || "ehealthscanner",
        pass: process.env.MYSQL_PASSWORD || "ehealthscanner",
        user: process.env.MYSQL_USER || "ehealthscanner",
        options,
    };

    winston.debug("DB CONFIGURATION =>", result);

    return result;
}

function getEmailConfig() {
    const smtpConfig = {
        host: process.env.EHS_SMTP_SERVER || "smtp.gmail.com",
        port: process.env.EHS_SMTP_PORT || "465",
        secure: process.env.EHS_SMTP_SECURE || true, // use SSL
        auth: {
            user: process.env.EHS_SMTP_AUTH_USER || "hello@ehealthscanner.com",
            pass: process.env.EHS_SMTP_AUTH_PASS || "8bM2PJzJS42a",
        },
    };
    const adminEmail = process.env.EHS_ADMIN_EMAIL || "rafa.hidalgo@apiumhub.com";
    const result = {smtpConfig, adminEmail};
    winston.debug("MAILER CONFIGURATION =>", result);
    return result;
}
